name: Deploy Prototipo TFM

on:
  push:
    branches:
      - deploy 

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ========== DESPLIEGUE DE BASE DE DATOS ==========
      - name: Copy database files to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "database/schema.sql"
          target: "/home/uo288347/tfm/prototipo_tfm/database/"
          overwrite: true
      
      - name: Deploy database
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Crear backup de la base de datos antes de ejecutar el script
            # (Esto guarda una copia por si algo sale mal)
            echo "Creando backup de la base de datos..."
            mysqldump ${{ secrets.DB_NAME }} > /tmp/backup_$(date +%Y%m%d_%H%M%S).sql || true
            
            # Ejecutar el script SQL
            # -u: usuario de MySQL
            # -p: contraseña (sin espacio después de -p)
            # < : redirige el archivo como entrada
            echo "Ejecutando script SQL..."
            mysql -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} < /home/uo288347/tfm/prototipo_tfm/database/schema.sql
            
            echo "Base de datos desplegada correctamente"
      
      # ========== BUILD Y DESPLIEGUE DE FRONTEND ==========
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build React app
        run: npm run build
        env:
      
      - name: Deploy frontend to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build/*"
          target: "/home/uo288347/tfm/prototipo_tfm/"
          rm: true
      
      - name: Restart Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl reload nginx
      
      - name: Deployment Completed
        run: |
          echo "Base de datos desplegada"
          echo "Frontend desplegado"
          echo "Aplicación lista en: http://${{ secrets.SSH_HOST }}"